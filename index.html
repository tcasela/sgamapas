<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <title>IDE SEFIN - S√£o Gon√ßalo do Amarante</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!--------------------------              ESTILOS             ------------------------->
<style>

/* ========================== VARI√ÅVEIS DE COR =========================== */
:root {

  --primariabrancofundo: #f8f8fa;
  --secundariaazulfundo: #98b5d8; 
  --terciariaverdeFundo: #a8c3a9 ; 
  --textoprincipalpreto:#000000; 
  --textosecundariobrancopuro: #ffffff; 
  --textoterciariocinza: #737373; 
  --primariabrancoborda: #dedede; 
  --secundariaazulborda: #6d97c4; 
  --secundariaazulescuro: #1a365d; 
  --terciariaverdeborda: #8aae8b;
  --terciariaverdeescuro: #5a8c5a;
  --quartariaamarelofundo: #fff17a;
  --quartariaamareloborda: #eed505;
  --quartariaamareloescuro: #efb936;
    }

    body, html {    /* Estilo Geral */
      margin: 0;
      padding: 0;
      height: 100vh;
      width: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
   
   
   /*  ===========================        MAPA              =========================== */

    #map {    /* √Årea do mapa */
      width: 100%;
      height: 100vh;
      margin: 0;
      padding: 0;
      background: #f5f7fa; /* fundo claro para n√£o parecer vazio */
    }

/* ==========================    ESTILOS DA BARRA LATERAL (SIDEBAR) =========================== */
    
/* Configura√ß√£o principal da barra lateral */
    .sidebar {
      position: absolute;                /* fixa a sidebar em rela√ß√£o √† tela */
      top: 0;                            /* come√ßa no topo da janela */
      left: 0;                           /* alinhada √† esquerda */
      height: 100vh;                     /* ocupa 100% da altura da janela */
      width: 270px;                      /* largura fixa */
      background: var(--primariabrancofundo);       /* cor de fundo usando vari√°vel CSS */
      border-right: 1px solid #1f2122;   /* borda direita */
      box-shadow: 2px 0 8px rgba(0,0,0,0.18); /* sombra lateral para destaque */
      z-index: 1100;                     /* garante que fique acima de outros elementos */
      display: flex;                     /* permite organizar elementos em coluna */
      flex-direction: column;
      gap: 10px;                         /* espa√ßamento entre blocos internos */
      padding: 10px;                     /* espa√ßamento interno */
      color: var(--textoprincipalpreto);      /* cor do texto */
      transition: transform 0.3s ease;   /* anima√ß√£o suave na abertura/fechamento */
      transform: translateX(0);          /* posi√ß√£o vis√≠vel padr√£o */
      overflow: hidden;                  /* esconde conte√∫do que ultrapassar os limites */
    }

/* Quando a sidebar est√° recolhida (fechada) */
    .sidebar.collapsed {
      transform: translateX(-270px);     /* move a barra totalmente para fora da tela */
      overflow: hidden;
    }

/* Oculta completamente o conte√∫do da sidebar recolhida */
    .sidebar.collapsed > * {
      opacity: 0;                        /* deixa transparente */
      pointer-events: none;              /* desativa cliques nos elementos */
      transition: opacity 0.2s ease;     /* suaviza o desaparecimento */
    }

/* Transi√ß√£o suave dos elementos internos da sidebar */
    .sidebar > * {
      transition: opacity 0.2s ease;
    }

/* ========================== SIDEBAR:BOT√ÉO DE ABRIR/FECHAR =========================== */
    .sidebar-toggle-bar {
      position: absolute;                /* posicionado em rela√ß√£o √† tela */
      top: 50%;                          /* centraliza verticalmente */
      left: 270px;                       /* fica logo √† direita da sidebar */
      transform: translateY(-50%);       /* centraliza de forma exata */
      width: 30px;
      height: 60px;
      background: var(--primariabrancofundo);       /* usa cor principal */
      border-left: none;                 /* sem borda do lado esquerdo */
      border-radius: 0 6px 6px 0;        /* arredonda o canto direito */
      display: flex;                     /* centraliza √≠cone */
      align-items: center;
      justify-content: center;
      cursor: pointer;                   /* muda o cursor ao passar o mouse */
      z-index: 1101;                     /* ligeiramente acima da sidebar */
      box-shadow: 2px 0 8px rgba(0,0,0,0.18);
      transition: left 0.3s ease;        /* movimento suave */
    }


/* Efeito hover do bot√£o */
    .sidebar-toggle-bar:hover {
      background: var(--primariabrancofundo);
    }

/* √≠cone do bot√£o de toggle (seta) */
    .sidebar-toggle-icon { 
      font-size: 18px;
      color: var(--terciariacont);
      transition: transform 0.3s ease;
    }

/* ========================== SIDEBAR: CABE√áALHO E SE√á√ïES INTERNAS =========================== */

/* Cabe√ßalho das se√ß√µes da sidebar */
    .sidebar-header {
      font-size: 14px;
      font-weight: bold;
      color: var(--terciariaverdeborda);
      margin-bottom: 4px;
    }

/* Blocos/se√ß√µes dentro da sidebar */
    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      background: #79797918;
      border-radius: 6px;        /* arredonda o canto direito */
    }

/* T√≠tulo da se√ß√£o (ex: "Camadas", "Configura√ß√µes") */
    .section-title {
      font-size: 13px;
      font-weight: bold;
      color: var(--textoprincipalpreto);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer; /* indica que pode ser clic√°vel */
      user-select: none;  /* impede sele√ß√£o de texto acidental */
    }

/* Campo de entrada de texto (pesquisa por nome da camada) */
    .sidebar input[type="text"] {
      padding: 6px 8px;
      font-size: 12px;
      border: 1px solid var(--textoterciariocinza);
      border-radius: 6px;
      background: var(--primariabrancofundo);
      color: var(--textoprincipalpreto);
      outline: none;
    }

/* Barra/Linha de cada camada na lista */
    .layer-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 8px;
      background: var(--primariabrancofundo);
      border-radius: 6px; 
    }

/* Bloco de categoria de camadas */
    .layer-category {
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #d0d4dd;
      background: #f5f7fb;
    }

    .layer-category-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      font-size: 12px;
      font-weight: bold;
      color: #1a365d;
      cursor: pointer;
      user-select: none;
    }

    .layer-category-toggle {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 1px solid #c0c4cf;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: #ffffff;
      color: #1a365d;
    }

    .layer-category-body {
      padding: 4px 6px 6px 6px;
    }

/* Bloco de subcategoria de camadas */
    .layer-subcategory {
      margin-bottom: 6px;
      border-radius: 6px;
      border: 1px dashed #c5ccd9;
      background: #ffffff;
    }

    .layer-subcategory-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px 6px;
      font-size: 11px;
      font-weight: 600;
      color: #2d3748;
      cursor: pointer;
      user-select: none;
    }

    .layer-subcategory-toggle {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #c0c4cf;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      background: #f7fafc;
      color: #2d3748;
    }

    .layer-subcategory-body {
      padding: 4px 4px 6px 4px;
      display: none; /* padr√£o: minimizado */
    }

/* Cabe√ßalho de cada linha (nome da camada e checkbox) */
    .layer-row-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: var(--textoterciariocinza);
      font-size: 12px;
    }

/* A√ß√µes dispon√≠veis para cada camada (ex: "Editar", "Excluir") */
    .layer-row-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

/* Bot√µes de a√ß√£o gen√©ricos */
    .action-btn {
      font-size: 11px;
      background: var(--primariabrancofundo);
      color: var(--secundaria);
      border: 1px solid #ffffff98;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer; /* quebra linha se houver muitos bot√µes */
    }

/* Bot√£o secund√°rio (ex: "Editar", "Excluir") */
    .action-btn.secondary {
      background: var(--primariabrancofundo);
      color: var(--secundaria);
      border: 1px solid #ffffff98;
      border-radius: 6px;
      padding: 4px 8px;
      cursor: pointer; /* quebra linha se houver muitos bot√µes */
    }

/* ========================== SIDEBAR: BARRA DE ROLAGEM ESTILIZADA =========================== */
    /* Webkit (Chrome, Safari, Edge) */
    .sidebar-section::-webkit-scrollbar,
    #presetLayerList::-webkit-scrollbar {
      width: 8px;
    }

    .sidebar-section::-webkit-scrollbar-track,
    #presetLayerList::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    .sidebar-section::-webkit-scrollbar-thumb,
    #presetLayerList::-webkit-scrollbar-thumb {
      background: var(--secundaria);
      border-radius: 10px;
      transition: background 0.3s ease;
    }

    .sidebar-section::-webkit-scrollbar-thumb:hover,
    #presetLayerList::-webkit-scrollbar-thumb:hover {
      background: var(--secundaria);
    }

    .sidebar-section,     /* Firefox */
    #presetLayerList {
      scrollbar-width: thin; /* fina */
      scrollbar-color: var(--secundaria) rgba(255, 255, 255, 0.05);
    }
   
/* ========================== RODAP√â =========================== */

/* Remove o fundo original do Leaflet */
.leaflet-control-attribution {
    background: transparent !important;
    font-size: 11px !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Faz o rodap√© do Leaflet ficar POR CIMA do seu rodap√© */
.leaflet-bottom {
    z-index: 3000 !important;   /* maior que o z-index do footer */
}

    .footer { /* barra de coordenadas */
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffffcc;; /* cor de fundo */
      height: 12px;          /* altura fixa */
      padding: 6px 12px; /* espa√ßamento interno */
      font-size: 11px; /* tamanho do texto */
      color: var(--terciariacont);  /* cor do texto */
      display: flex;   /* layout em linha */
      justify-content: space-between; /* texto espa√ßado */
      align-items: center; /* alinhamento vertical */
      font-family: sans-serif;
      z-index: 1000;
    }

    .sefin-logo {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      padding: 5px;
      opacity: 0.8; /* valor entre 0 (totalmente transparente) e 1 (opaco) */
    }

    .sefin-logo img {
      height: 40px;
      width: auto;
    }

   .leaflet-control-graphic-scale {     /* Cont√™iner da escala */
     position: absolute;
    bottom: 50px; /* Posicionado acima do rodap√© */
     left: 20px;
    display: flex;
   flex-direction: column;
    align-items: center;
     font-family: sans-serif;
     font-size: 12px;
    font-weight: bold;
  }

    .scale-bar {   /* Barra com blocos */
      display: flex;
      border: 2px solid #0a4bac;
      height: 20px;
      width: 150px;
  }

    .scale-block {  /* Blocos alternados */
    flex: 1;
    background-color:  #ffffff69;
  }
    .scale-block:nth-child(odd) { background-color: #000000; }
    .scale-value { /* Valor em cima da barra */
      margin-bottom: 2px;
      position: relative;
      bottom: 5px; /* ajuste fino */
  }
 
 /* ==========================   ROTULOS: Lotes Fiscais  =========================== */

    .lote-label {    /* Rotulo da Camada Lotes Fiscais */
      background: none;        /* sem fundo */
      border: none;            /* sem borda */
      padding: 0;              /* sem espa√ßamento interno */
      font-size: 8px;         /* texto pequeno */
      font-weight: normal;     /* sem negrito */
      color: gray;            /* cor do texto */
      text-align: center;      /* centralizado sobre o lote */
      box-shadow: none;        /* remove sombra padr√£o */
}

 /* ==========================   BOT√ïES  =========================== */

/* Ocultar controles de zoom do Leaflet */
.leaflet-control-zoom {
  display: none !important;
}

/* Bot√µes personalizados de controle do mapa */
.custom-map-controls {
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 25px; /* espa√ßo entre grupos */
}

/* Cada grupo de bot√µes */
.control-group {
      display: flex;
      flex-direction: column;
      gap: 5px; /* espa√ßo entre bot√µes do mesmo grupo */
    }

.custom-control-btn {
  width: 28px; /* Reduzido 20% de 40px */
  height: 28px; /* Reduzido 20% de 40px */
  background:var(--primariabrancofundo);
  border: 2px solid var(--primariabrancofundo);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: all 0.2s ease;
  font-size: 18px; /* Mantido o mesmo tamanho do s√≠mbolo */
  font-weight: bold;
  color: var(--quartariaamareloborda);
}

.custom-control-btn:hover {
  background:  var(--primariabrancoborda)  ; /* Aumenta opacidade no clique */
  border-color: var(--primariabrancoborda) ;
  transform: scale(1.05);
}

.custom-control-btn:hover:after {
  color: var(--secundariaazulescuro) !important;
}

.custom-control-btn:active {
  background: var(--primariabrancoborda); /* Aumenta opacidade no clique */
  transform: scale(0.95);
}

.custom-control-btn.zoom-in:after {
  content: "+";
  color: var(--textoterciariocinza);
}

.custom-control-btn.zoom-out:after {
  content: "‚àí";
  color: var(--textoterciariocinza);
}

.custom-control-btn.center:after {
  content: "‚óè"; /* Ponto preenchido */
  font-size: 16px;
  color: var(--textoterciariocinza);
}

.custom-control-btn.info:after {
  content: "‚Ö∞"; 
  font-size: 16px;
  color: var(--textoterciariocinza);
}

.custom-control-btn.med-line:after {
  content: "‚Üî"; 
  font-size: 16px;
  color: var(--textoterciariocinza);
}

.custom-control-btn.med-area:after {
  content: "‚≠ì";
  font-size: 16px;
  color: var(--textoterciariocinza);
}

.custom-control-btn.coord:after {
  content: "‚äö";
  font-size: 16px;
  color: var(--textoterciariocinza);
}
.custom-control-btn.layers:after {
  content: "‚ò∞";
  font-size: 16px;
  color: var(--textoterciariocinza);
}
.custom-control-btn.search:after {
  content: "üîçÔ∏é";
  font-size: 16px;
  color: var(--textoterciariocinza);
}


 /* ==========================   Logo SEFIN  (Buffer) =========================== */

.sefin-logo img {
  width: 160px;
  filter: drop-shadow(2px 0 0 rgb(255, 255, 255))
          drop-shadow(-2px 0 0 rgb(255, 255, 255))
          drop-shadow(0 2px 0 rgb(255, 255, 255))
          drop-shadow(0 -2px 0 rgb(255, 255, 255))
}

</style>  
</head>



<!------------                          CONTE√öDO VIS√çVEL                       ------------>


<body class="sidebar-closed">

<!-- =====================  SIDEBAR esquerda  ====================== --> 

  <div class="sidebar collapsed" id="sidebar">
    <!--
      .sidebar ‚Üí painel lateral esquerdo fixo
      .collapsed ‚Üí classe que indica que est√° recolhida
      #sidebar ‚Üí usado pelo JavaScript para alternar o estado
    -->

  <!-- Cabe√ßalho da Sidebar (pode conter logo, t√≠tulo, etc.) -->
   <div class="sidebar-header"> </div> 

<!-- =====================  BLOCO: PESQUISAR CAMADA  ====================== -->
    <!-- Removido: busca agora fica dentro de "Camadas Dispon√≠veis" -->

<!-- =====================  BLOCO: CAMADAS DISPON√çVEIS  ====================== -->

    <div class="sidebar-section">       <!-- T√≠tulo com √≠cone + seta de expans√£o -->
      <div class="section-title" id="availableLayersToggle">
        <div style="display:flex; align-items:center; gap:6px;">
          <!-- √çcone SVG representando pilha de camadas -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          </svg>
          <span>Camadas Dispon√≠veis</span>
        </div>

        <!-- Chevron (seta) indicando expans√£o ou recolhimento -->
        <span id="availableLayersChevron">‚ñ∏</span>
      </div>

      <!-- Lista de camadas carregadas dinamicamente via JS -->
      <!-- Campo de busca e lista encapsulados para ocultar juntos -->
      <div id="availableLayersContent" style="display:none; flex-direction:column; gap:8px;">
        <input type="text" id="layerSearchInput" placeholder="Buscar por nome da camada" style="margin-top:8px;">
        <div id="presetLayerList" style="display:flex; flex-direction:column; gap:8px; max-height: calc(100vh - 260px); overflow:auto;"></div>
      </div>
    </div>


<!-- =====================  BLOCO: IM√ìVEIS URBANOS  ====================== -->

    <div class="sidebar-section">
      <!-- Cabe√ßalho com √≠cone e seta de expans√£o -->
      <div class="section-title" id="imoveisUrbanosToggle">
        <div style="display:flex; align-items:center; gap:6px;">
          <!-- √çcone de casa -->
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0;">
            <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" 
            stroke="currentColor" 
            stroke-width="2" 
            stroke-linecap="round" 
            stroke-linejoin="round" 
            fill="none"/>
            <path d="M9 22V12H15V22" 
            stroke="currentColor" 
            stroke-width="2" 
            stroke-linecap="round" 
            stroke-linejoin="round" 
            fill="none"/>
          </svg>
          <span>Im√≥veis Urbanos</span>
        </div>

        <!-- Chevron para recolher/expandir -->
        <span id="imoveisUrbanosChevron">‚ñ∏</span>
      </div>

      <!-- Painel interno (oculto at√© o toggle ser clicado) -->
      <div id="imoveisUrbanosPanel" style="display:none; flex-direction:column; gap:6px; margin-top:8px;">
        <input type="text" id="searchInscricaoImovel" placeholder="Inscri√ß√£o Municipal" 
              style="padding:6px 8px; 
              font-size:12px; 
              border:1px solid #4b4d4e; 
              border-radius:6px; 
              background: var(--secundariacont);  
              color:var(--terciariacont); 
              outline:none;">
        <input type="text" id="searchDistritoImovel" placeholder="Distrito" 
              style="padding:6px 8px; 
              font-size:12px; 
              border:1px solid #4b4d4e;
              border-radius:6px; 
              background: var(--secundariacont); 
              color:var(--terciariaon); 
              outline:none;">
        <input type="text" id="searchSetorImovel" placeholder="Setor Fiscal" 
              style="padding:6px 8px; 
              font-size:12px; 
              border:1px solid #4b4d4e; 
              border-radius:6px; 
              background: var(--secundariacont);  
              color:var(--primariacont); 
              outline:none;">
        <input type="text" id="searchQuadraImovel" placeholder="Quadra" 
              style="padding:6px 8px; 
              font-size:12px; 
              border:1px solid #4b4d4e; 
              border-radius:6px; 
              background: var(--secundariacont); 
              color:var(--primariacont); 
              outline:none;">
        <input type="text" id="searchLoteImovel" placeholder="Lote" 
              style="padding:6px 8px; 
              font-size:12px; 
              border:1px solid #4b4d4e; 
              border-radius:6px; 
              background: var(--secundariacont);  
              color:var(--primariacont); 
              outline:none;">

        <!-- Bot√£o de busca de im√≥vel -->
        <button id="searchImovelBtn" 
        style="padding:6px 8px; 
                font-size:12px; 
                background:var(--terciariacont); 
                color:var(--primaria); 
                border:none; 
                border-radius:6px; 
                cursor:pointer; 
                font-weight:bold; 
                margin-top:4px;">Pesquisar</button>
      </div>
    </div>
  </div>

<!-- Barra de toggle para expandir/colapsar sidebar -->
  <div class="sidebar-toggle-bar" id="sidebarToggleBar">
    <span class="sidebar-toggle-icon">‚ñ∂</span>
  </div>

  <div id="map"></div> 
  
  <!-------------------------------------------- MAPA ------------------------------------------>
  
  <!-- Bot√µes personalizados de controle do mapa -->
  <div class="custom-map-controls">

   <!-- Grupo 1: zoom e centralizar -->
   <div class="control-group">
    <button class="custom-control-btn zoom-in" id="zoomInBtn" title="Zoom In"></button>
    <button class="custom-control-btn center" id="centerBtn" title="Centralizar Mapa"></button>
    <button class="custom-control-btn zoom-out" id="zoomOutBtn" title="Zoom Out"></button>
  </div>

<!-- Bot√£o de pesquisa de lote - Inativado (Foi inserido outra fun√ß√£o para substituir na sidebar) -->
 <button class="custom-control-btn search" 
        id="searchBtn" 
        title="Pesquisar Lote"
        ></button>

    <!-- Painel de pesquisa de lote-->
    <div id="searchPanel" 
    style="display:none; position:absolute; 
            top:0; 
            right:50px; 
            background:#ffffff8e; 
            border:1px solid #ffffffd3; 
            padding:8px; 
            border-radius:6px; 
            box-shadow:0 2px 6px #00000033; 
            z-index:1100; 
            width:250px;">
              <label style="font-size:12px; 
              color:var(--primaria); 
              font-weight:bold; 
              display:block; 
              margin-bottom:4px; "></label>
      <div style="display:flex; flex-direction:column; gap:4px;">

        <input type="text" id="searchInscricao" placeholder="Inscri√ß√£o Municipal" 
              style="padding:4px 6px; 
              font-size:12px; 
              border:1px solid #d6d6d6; 
              border-radius:4px;">

        <input type="text" id="searchDistrito" placeholder="Distrito" 
              style="padding:4px 6px; 
              font-size:12px; 
              border:1px solid #d6d6d6; 
              border-radius:4px;">

        <input type="text" id="searchSetor" placeholder="Setor Fiscal" 
              style="padding:4px 6px; 
              font-size:12px; 
              border:1px solid #d6d6d6; 
              border-radius:4px;">

        <input type="text" id="searchQuadra" placeholder="Quadra" 
              style="padding:4px 6px; 
              font-size:12px; 
              border:1px solid #d6d6d6; 
              border-radius:4px;">

        <input type="text" id="searchLote" placeholder="Lote" 
              style="padding:4px 6px; 
              font-size:12px; 
              border:1px solid #d6d6d6; 
              border-radius:4px;">

        <button id="searchExecuteBtn" 
        style="padding:4px 8px; 
        font-size:12px; 
        background: var(--primaria); 
        color:#fff; border:none; 
        border-radius:4px; 
        cursor:pointer; 
        font-family:'Lexend', sans-serif; 
        font-weight:bold;">
        Pesquisar</button> 
      </div>
    </div>

  <!-- Grupo 2: restante -->
  <div class="control-group">
    <button class="custom-control-btn info" id="infoBtn" title="Informa√ß√µes das Fei√ß√µes"></button>
    <button class="custom-control-btn coord" id="coordBtn" title="Coordenadas"></button>
    <button class="custom-control-btn med-line" id="medLineBtn" title= "Medir Dist√¢ncia"></button>
    <button class="custom-control-btn med-area" id="medAreaBtn" title= "Medir √Årea"></button>
    <button class="custom-control-btn layers" id="layersBtn" title="Adicionar Camadas"></button>

              <!-- Painel de pesquisa de coordenadas -->
            <div id="coordPanel" 
            style="display:none; 
                  position:absolute; 
                  top:0; 
                  right:50px; 
                  background:#ffffff8e; 
                  border:1px solid #ffffffd3; 
                  padding:8px; 
                  border-radius:6px; 
                  box-shadow:0 2px 6px #00000033; 
                  z-index:1100;">
              <label for="coordInput" 
              style="font-size:12px; 
                    color:var(--primaria); 
                    margin-bottom:4px; 
                    display:block; 
                    font-family:'Lexend', sans-serif; 
                    font-weight:bold;" > Digite coordenadas:
              </label>
              <div style="display:flex; align-items:center; gap:4px;">
                <input type="text" id="coordInput" placeholder="Ex: -3.608388, -38.966187"
                      style="flex:1; 
                            padding:4px 6px; 
                            font-size:12px; 
                            font-family:'Inter', sans-serif; 
                            border:1px solid #d6d6d6; 
                            border-radius:4px;">
                <button id="coordSearchBtn"
                        style="padding:4px 8px; 
                        font-size:12px; 
                        background:var(--primaria); 
                        color:#fff; 
                        border:none; 
                        border-radius:4px; 
                        cursor:pointer;"> Ir
                </button>
              </div>
            </div>
            <!-- painel lateral antigo removido (substitu√≠do pela sidebar √† esquerda) -->
            </div>

          </div>           
<!-----------------------------------                SCRIPT           --------------------------------------------------------------->
  <script>

     // Centraliza√ß√£o do mapa ajustada aos limites reais
var map = L.map('map').setView(
    [-3.591, -39.0645],
    11
);

    // Base padr√£o: OpenStreetMap
    var baseOSM = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      {
        maxZoom: 22,
        attribution: '¬© OpenStreetMap contributors'
      }
    ).addTo(map);

    // Base alternativa: Esri World Imagery
    var baseEsri = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      {
        maxZoom: 22,
        attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, Maxar, Earthstar Geographics, and the GIS User Community'
      }
    );

    L.control.scale({imperial: false}).addTo(map);    // Escala gr√°fica

    // Toggle da sidebar
    const sidebar = document.getElementById('sidebar');
    const sidebarToggleBar = document.getElementById('sidebarToggleBar');
    
    function updateToggleBarPosition() {
      if (sidebar.classList.contains('collapsed')) {
        sidebarToggleBar.style.left = '0';
        sidebarToggleBar.querySelector('.sidebar-toggle-icon').textContent = '‚ñ∂';
      } else {
        sidebarToggleBar.style.left = '270px';
        sidebarToggleBar.querySelector('.sidebar-toggle-icon').textContent = '‚óÄ';
      }
    }
    
    sidebarToggleBar.addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
      updateToggleBarPosition();
      // For√ßa redesenho do mapa
      setTimeout(function() {
        map.invalidateSize();
      }, 300);
    });
    
    // Inicializa a posi√ß√£o da barra de toggle
    updateToggleBarPosition();

    // Coordenadas iniciais para centraliza√ß√£o
    var initialCenter = [-3.608388, -38.966187];
    var initialZoom = 12;

    // Funcionalidades dos bot√µes personalizados
    document.getElementById('zoomInBtn').addEventListener('click', function() {
      map.zoomIn();
    });

    document.getElementById('zoomOutBtn').addEventListener('click', function() {
      map.zoomOut();
    });

    document.getElementById('centerBtn').addEventListener('click', function() {
      map.setView(initialCenter, initialZoom);
    });

    map.on("mousemove", function(e) {    // Atualizar coordenadas no rodap√© (latitude/longitude)
      document.getElementById("coords").innerHTML =
        "Coordenadas: " + e.latlng.lat.toFixed(5) + " , " + e.latlng.lng.toFixed(5);
    });


    // CAMADA WMS: LIMITE MUNICIPAL SGA - IN√çCIO
    let limiteSGALayer;

    function loadLimiteSGALayer() {
        const zoom = map.getZoom();

        // Exibe camada apenas a partir do zoom 10 (ajuste se quiser)
        if (zoom < 10) {
            if (limiteSGALayer) {
                map.removeLayer(limiteSGALayer);
                limiteSGALayer = null;
            }
            return;
        }

        // Remove camada antiga se j√° existir
        if (limiteSGALayer) {
            map.removeLayer(limiteSGALayer);
        }

        // Adiciona camada WMS
        limiteSGALayer = L.tileLayer.wms(
            "http://10.1.0.102:8080/geoserver/idesefin/wms",
            {
                layers: "idesefin:tb_limite_sga",
                format: "image/png",
                transparent: true,
                version: "1.1.0",
                attribution: "GeoServer | IDE SEFIN",
                tiled: true
            }
        ).addTo(map);
    }

    // Chamada inicial
    loadLimiteSGALayer();

    // Atualiza ao mudar o zoom
    map.on("zoomend", loadLimiteSGALayer);
    // CAMADA WMS: LIMITE MUNICIPAL SGA - FIM

/*
      // CAMADA WMS: LOTES FISCAIS - IN√çCIO
let lotesLayer;

function loadLotesLayer() {
    const zoom = map.getZoom();

    // Exibe camada apenas a partir do zoom 14
    if (zoom < 14) {
        if (lotesLayer) {
            map.removeLayer(lotesLayer);
            lotesLayer = null;
        }
        return;
    }

    // Remove camada antiga se j√° existir
    if (lotesLayer) {
        map.removeLayer(lotesLayer);
    }

    // Adiciona camada WMS
    lotesLayer = L.tileLayer.wms("http://10.1.0.102:8080/geoserver/idesefin/wms", {
        layers: "idesefin:tb_lotes_fiscais",
        format: "image/png",
        transparent: true,
        version: "1.1.0",
        srs: "EPSG:4326",
        attribution: "GeoServer - IDE SEFIN",
    }).addTo(map);
}

// Chama inicialmente
loadLotesLayer();

// Atualiza camada ao mover ou dar zoom no mapa
map.on("zoomend", loadLotesLayer);

// CAMADA WMS: LOTES FISCAIS - FIM
*/

// FUN√á√ÉO DE PESQUISA DE LOTE - Inicio
// Toggle painel de pesquisa de lote
const searchBtn = document.getElementById('searchBtn');
const searchPanel = document.getElementById('searchPanel');

searchBtn.addEventListener('click', () => {
  searchPanel.style.display = (searchPanel.style.display === 'block') ? 'none' : 'block';
});

// Fun√ß√£o de pesquisa de lote
document.getElementById('searchExecuteBtn').addEventListener('click', () => {
  const inscricao = document.getElementById('searchInscricao').value.trim();
  const distrito = document.getElementById('searchDistrito').value.trim();
  const setor = document.getElementById('searchSetor').value.trim();
  const quadra = document.getElementById('searchQuadra').value.trim();
  const lote = document.getElementById('searchLote').value.trim();

  if (!lotesLayer) {
    alert("Camada de lotes n√£o carregada!");
    return;
  }

  let found = false;

  lotesLayer.eachLayer(layer => {
    const props = layer.feature.properties;

    // Verifica se todos os campos preenchidos correspondem
    const match = 
      (!inscricao || (props.n_inscricao && props.n_inscricao.includes(inscricao))) &&
      (!distrito || (props.cd_distrito && props.cd_distrito.includes(distrito))) &&
      (!setor || (props.cd_setor_fiscal && props.cd_setor_fiscal.includes(setor))) &&
      (!quadra || (props.cd_quadra && props.cd_quadra.includes(quadra))) &&
      (!lote || (props.cd_lote && props.cd_lote.includes(lote)));

    if (match) {
      // Centraliza e abre popup do lote encontrado
      map.fitBounds(layer.getBounds());
      layer.openPopup();
      found = true;
    }
  });

  if (!found) {
    alert("Nenhum lote encontrado com os crit√©rios informados.");
  }
});
// FUN√á√ÉO DE PESQUISA DE LOTE - Fim



// FUN√á√ÉO DE PESQUISA DE COORDENADAS - Inicio
var coordBtn = document.getElementById('coordBtn'); // Seleciona o bot√£o existente
var coordPanel = document.getElementById('coordPanel');
var tempMarker = null; // marcador tempor√°rio

// Toggle: mostrar/esconder painel
coordBtn.addEventListener('click', function() {
  coordPanel.style.display = (coordPanel.style.display === 'block') ? 'none' : 'block';
});

// Fun√ß√£o para criar um marcador SVG personalizado
function createSvgMarker(lat, lng, color = "#ff0000", title = "Coordenada Tempor√°ria") {
    const svgHtml = `
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
            <path fill="${color}" d="M12 2C8 2 5 5 5 9c0 5 7 13 7 13s7-8 7-13c0-4-3-7-7-7z"/>
        </svg>
    `;

    return L.marker([lat, lng], {
        icon: L.divIcon({
            className: 'custom-marker',
            html: svgHtml,
            iconSize: [32, 32],
            iconAnchor: [16, 32] // centraliza a ponta do marcador
        }),
        title: title
    }).addTo(map);
}

// Fun√ß√£o para processar coordenadas
document.getElementById('coordSearchBtn').addEventListener('click', function() {
  var input = document.getElementById('coordInput').value.trim();
  if(input) {
    var parts = input.split(',');
    if(parts.length === 2) {
      var lat = parseFloat(parts[0]);
      var lng = parseFloat(parts[1]);
      if(!isNaN(lat) && !isNaN(lng)) {
        // Centraliza o mapa
        map.setView([lat, lng], 18);

        // Remove marcador antigo se existir
        if(tempMarker) {
          map.removeLayer(tempMarker);
        }

        // Adiciona o marcador tempor√°rio e atualiza a vari√°vel global
        tempMarker = createSvgMarker(lat, lng, "#008457", "Coordenada Tempor√°ria");

        // Fecha painel opcionalmente
        coordPanel.style.display = 'none';
      } else {
        alert('Coordenadas inv√°lidas!');
      }
    } else {
      alert('Formato inv√°lido! Use lat,lng.');
    }
  } else {
    alert('Digite alguma coordenada.');
  }
});
// FUN√á√ÉO DE PESQUISA DE COORDENADAS - Fim


// GERENCIADOR DE CAMADAS DIN√ÇMICAS (lista na sidebar) - n√£o h√° mais painel flutuante

// LISTA DE CAMADAS PR√â-DEFINIDAS (WMS) - In√≠cio
const presetLayerList = document.getElementById('presetLayerList');
const PRESET_WMS = [
  // üóÇ TERRITORIAIS / üìå Limites Administrativos
  {
    nome: "Distritos",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_distritos&bbox=464983.03125%2C9589708.0%2C521484.40625%2C9616345.0&width=768&height=362&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_distritos",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Administrativos"
  },
  {
    nome: "Bairros",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_bairros&bbox=464983.03125%2C9589708.0%2C521484.40625%2C9616345.0&width=768&height=362&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_bairros",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Administrativos"
  },
  {
    nome: "Setores Censit√°rios",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_setores_censitarios&bbox=464983.03125%2C9589708.0%2C521475.75%2C9616969.0&width=768&height=370&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_setores_censitarios",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Administrativos"
  },
  {
    nome: "Lotes Fiscais",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_lotes_fiscais&bbox=487551.0625%2C9594149.0%2C519953.65625%2C9616150.0&width=768&height=521&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_lotes_fiscais",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Administrativos"
  },
  {
    nome: "Zonas Cartoriais",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_cartorio_sga&bbox=464983.03125%2C9589708.0%2C521484.40625%2C9616345.0&width=768&height=362&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_cartorio_sga",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Administrativos"
  },

  // üóÇ TERRITORIAIS / üåø Limites Ambientais
  {
    nome: "Bacia Hidrogr√°fica",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_distritos&bbox=464983.03125%2C9589708.0%2C521484.40625%2C9616345.0&width=768&height=362&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_distritos",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Ambientais"
  },
  {
    nome: "Linha de Preamar",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_linha_preamar_marinha&bbox=506709.375%2C9607073.0%2C519201.0%2C9616247.0&width=768&height=564&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_linha_preamar_marinha",
    categoria: "TERRITORIAIS",
    subcategoria: "Limites Ambientais"
  },

  // üìç LOCALIDADES
  {
    nome: "Localidades",
    urlCompleta: "http://10.1.0.102:8080/geoserver/idesefin/wms?service=WMS&version=1.1.0&request=GetMap&layers=idesefin%3Atb_localidade_sga_ipece_2023&bbox=466147.0%2C9590652.0%2C519915.78125%2C9613159.0&width=768&height=330&srs=EPSG%3A31984&styles=&format=application/openlayers",
    layers: "idesefin:tb_localidade_sga_ipece_2023",
    categoria: "TERRITORIAIS",
    subcategoria: "Localidades"
  },

  // üìú LEGISLA√á√ÉO ‚Äì Plano Diretor
  {
    nome: "Zonas",
    urlCompleta: "",
    layers: "idesefin:tb_plano_diretor_zonas_sga",
    categoria: "LEGISLA√á√ÉO",
    subcategoria: "Plano Diretor SGA"
  },
  {
    nome: "Subzonas",
    urlCompleta: "",
    layers: "idesefin:tb_plano_diretor_subzonas_sga",
    categoria: "LEGISLA√á√ÉO",
    subcategoria: "Plano Diretor SGA"
  },
  {
    nome: "Usos",
    urlCompleta: "",
    layers: "idesefin:tb_plano_diretor_uso_sga",
    categoria: "LEGISLA√á√ÉO",
    subcategoria: "Plano Diretor SGA"
  },

  // üèó INFRAESTRUTURA E EQUIPAMENTOS P√öBLICOS / üéì Educa√ß√£o
  {
    nome: "Escolas",
    urlCompleta: "",
    layers: "idesefin:ep_saude",
    categoria: "EQUIPAMENTOS P√öBLICOS",
    subcategoria: "Educa√ß√£o"
  },

  // üèó INFRAESTRUTURA E EQUIPAMENTOS P√öBLICOS / üè• Sa√∫de
  {
    nome: "Unidades de Sa√∫de",
    urlCompleta: "",
    layers: "idesefin:ep_saude",
    categoria: "EQUIPAMENTOS P√öBLICOS",
    subcategoria: "Sa√∫de"
  },

  // üèó INFRAESTRUTURA E EQUIPAMENTOS P√öBLICOS / üöî Seguran√ßa P√∫blica
  {
    nome: "Seguran√ßa",
    urlCompleta: "",
    layers: "idesefin:ep_seguranca",
    categoria: "EQUIPAMENTOS P√öBLICOS",
    subcategoria: "Seguran√ßa P√∫blica"
  },

  // üèó INFRAESTRUTURA E EQUIPAMENTOS P√öBLICOS / ‚ö° Energia
  {
    nome: "Aerogeradores",
    urlCompleta: "",
    layers: "idesefin:ep_energia_aerogeradores",
    categoria: "EQUIPAMENTOS P√öBLICOS",
    subcategoria: "Energia"
  },
  {
    nome: "Usinas Fotovoltaicas",
    urlCompleta: "",
    layers: "idesefin:ep_energia_fotovoltaica",
    categoria: "EQUIPAMENTOS P√öBLICOS",
    subcategoria: "Energia"
  },
  {
    nome: "Usinas Termoel√©tricas",
    urlCompleta: "",
    layers: "idesefin:ep_energia_termoeletrica",
    categoria: "EQUIPAMENTOS P√öBLICOS",
    subcategoria: "Energia"
  }
];

function buildPresetList() {
  presetLayerList.innerHTML = '';

  // Agrupa por categoria e subcategoria
  const grouped = {};
  PRESET_WMS.forEach(preset => {
    const cat = preset.categoria || 'Outros';
    const sub = preset.subcategoria || 'Outros';
    if (!grouped[cat]) grouped[cat] = {};
    if (!grouped[cat][sub]) grouped[cat][sub] = [];
    grouped[cat][sub].push(preset);
  });

  const createRow = (preset) => {
    const row = document.createElement('div');
    row.dataset.name = preset.nome;
    row.className = 'layer-row';

    const header = document.createElement('div');
    header.className = 'layer-row-header';

    // Grupo esquerdo: checkbox + nome da camada
    const leftGroup = document.createElement('div');
    leftGroup.style.display = 'flex';
    leftGroup.style.alignItems = 'center';
    leftGroup.style.gap = '6px';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.style.cursor = 'pointer';

    const title = document.createElement('span');
    title.textContent = preset.nome;
    title.style.fontWeight = 'bold';

    let layerInstance = null;

    checkbox.addEventListener('change', function() {
      if (checkbox.checked) {
        if (!layerInstance) {
          // Usa a URL base do WMS derivada da urlCompleta, quando dispon√≠vel
          const wmsUrl = (preset.urlCompleta && preset.urlCompleta.includes('?'))
            ? preset.urlCompleta.split('?')[0]
            : 'http://10.1.0.102:8080/geoserver/idesefin/wms';

          layerInstance = L.tileLayer.wms(wmsUrl, {
            layers: preset.layers,
            format: 'image/png',
            transparent: true,
            version: '1.1.1',
            zIndex: 500
          }).addTo(map);
          if (layerInstance.bringToFront) layerInstance.bringToFront();
        } else {
          layerInstance.addTo(map);
          if (layerInstance.bringToFront) layerInstance.bringToFront();
        }
      } else {
        if (layerInstance) map.removeLayer(layerInstance);
      }
    });

    leftGroup.appendChild(checkbox);
    leftGroup.appendChild(title);
    header.appendChild(leftGroup);

    const subtitle = document.createElement('div');
    const small = document.createElement('span');
    small.textContent = preset.layers;
    small.style.fontSize = '10px';
    small.style.opacity = '0.9';
    subtitle.appendChild(small);

    const toUrl = (fmt) => {
      const base = 'http://10.1.0.102:8080/geoserver/idesefin/ows?service=WFS&version=1.0.0&request=GetFeature';
      const typeName = encodeURIComponent(preset.layers);
      const srsName = 'EPSG:4326';
      let outputFormat = fmt;
      if (fmt === 'kml') outputFormat = 'application/vnd.google-earth.kml+xml';
      if (fmt === 'geojson') outputFormat = 'application/json';
      if (fmt === 'shp') outputFormat = 'SHAPE-ZIP';
      if (fmt === 'csv') outputFormat = 'csv';
      return `${base}&typeName=${typeName}&outputFormat=${encodeURIComponent(outputFormat)}&srsName=${srsName}`;
    };

    const mkBtn = (label, cls) => {
      const b = document.createElement('button');
      b.className = `action-btn ${cls||''}`;
      b.textContent = label;
      return b;
    };

    // √çcones SVG para informa√ß√£o e download
    const infoIconSvg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" fill="#1a365d"/>
        <rect x="11" y="10" width="2" height="7" fill="#ffffff"/>
        <rect x="11" y="7" width="2" height="2" fill="#ffffff"/>
      </svg>
    `;

    const downloadIconSvg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
        <path d="M5 20h14v-2H5v2zm7-16l-5 6h3v6h4v-6h3l-5-6z" fill="#1a365d"/>
      </svg>
    `;

    // Grupo direito: √≠cones de a√ß√£o (informa√ß√£o + download)
    const rightGroup = document.createElement('div');
    rightGroup.style.display = 'flex';
    rightGroup.style.alignItems = 'center';
    rightGroup.style.gap = '6px';
    rightGroup.style.marginLeft = 'auto';

    // Bot√£o √∫nico de Download com menu de formatos (√≠cone SVG)
    const btnDownload = mkBtn('', '');
    btnDownload.innerHTML = downloadIconSvg;
    btnDownload.style.position = 'relative';
    btnDownload.title = 'Download da camada';

    const menu = document.createElement('div');
    menu.style.display = 'none';
    menu.style.position = 'absolute';
    menu.style.top = '28px';
    menu.style.left = '0';
    menu.style.background = '#00262b9a'; /// ------------------------------- Ajustar a cor e a transpar√™ncia
    menu.style.backdropFilter = 'blur(2px)';
    menu.style.border = '1px solid #2a314d';
    menu.style.borderRadius = '6px';
    menu.style.padding = '6px';
    menu.style.zIndex = '1200';
    menu.style.minWidth = '140px';

    const itemStyle = 'display:block; width:100%; text-align:left; padding:6px 8px; font-size:11px; color:#fff; background:transparent; border:none; cursor:pointer;';

    const optKml = document.createElement('button');
    optKml.style = itemStyle;
    optKml.textContent = 'KML';
    optKml.addEventListener('click', () => { window.open(toUrl('kml'), '_blank'); menu.style.display = 'none'; });

    const optGeo = document.createElement('button');
    optGeo.style = itemStyle;
    optGeo.textContent = 'GeoJSON';
    optGeo.addEventListener('click', () => { window.open(toUrl('geojson'), '_blank'); menu.style.display = 'none'; });

    const optShp = document.createElement('button');
    optShp.style = itemStyle;
    optShp.textContent = 'Shapefile';
    optShp.addEventListener('click', () => { window.open(toUrl('shp'), '_blank'); menu.style.display = 'none'; });

    const optCsv = document.createElement('button');
    optCsv.style = itemStyle;
    optCsv.textContent = 'CSV';
    optCsv.addEventListener('click', () => { window.open(toUrl('csv'), '_blank'); menu.style.display = 'none'; });

    menu.appendChild(optKml);
    menu.appendChild(optGeo);
    menu.appendChild(optShp);
    menu.appendChild(optCsv);

    // Wrapper para manter posi√ß√£o relativa do menu ao bot√£o
    const downloadWrap = document.createElement('div');
    downloadWrap.style.position = 'relative';
    downloadWrap.style.display = 'inline-block';
    downloadWrap.appendChild(btnDownload);
    downloadWrap.appendChild(menu);

    btnDownload.addEventListener('click', (e) => {
      e.stopPropagation();
      menu.style.display = (menu.style.display === 'none') ? 'block' : 'none';
    });

    // Fechar menu ao clicar fora
    document.addEventListener('click', () => { menu.style.display = 'none'; });

    // Bot√£o de informa√ß√£o (√≠cone SVG)
    const btnInfo = mkBtn('', 'secondary');
    btnInfo.innerHTML = infoIconSvg;
    btnInfo.title = 'Informa√ß√µes da camada';
    btnInfo.addEventListener('click', (e) => {
      e.stopPropagation();
      const resumo = [
        `Nome: ${preset.nome}`,
        `Categoria: ${preset.categoria || '-'}`,
        `Subcategoria: ${preset.subcategoria || '-'}`,
        `Layers: ${preset.layers}`,
        `URL completa: ${preset.urlCompleta || '(n√£o definida)'}`
      ].join('\n');
      alert(resumo);
    });

    // Ordem: primeiro informa√ß√£o, depois download
    rightGroup.appendChild(btnInfo);
    rightGroup.appendChild(downloadWrap);
    header.appendChild(rightGroup);

    row.appendChild(header);
    // subtitle ocultado: n√£o anexado

    return row;
  };

  // Cria a estrutura hier√°rquica na sidebar
  Object.keys(grouped).sort((a, b) => a.localeCompare(b, 'pt-BR')).forEach(cat => {
    const catSection = document.createElement('div');
    catSection.className = 'layer-category';

    const catHeader = document.createElement('div');
    catHeader.className = 'layer-category-header';

    // √çcone por categoria
    let catIcon = 'üìÅ';
    if (cat === 'TERRITORIAIS') catIcon = 'üó∫Ô∏è';
    if (cat === 'LEGISLA√á√ÉO') catIcon = 'üìú';
    if (cat === 'EQUIPAMENTOS P√öBLICOS') catIcon = 'üèõÔ∏è';

    const catTitle = document.createElement('span');
    catTitle.textContent = `${catIcon} ${cat}`;

    const catToggle = document.createElement('div');
    catToggle.className = 'layer-category-toggle';
    catToggle.textContent = '+'; // padr√£o: minimizado

    catHeader.appendChild(catTitle);
    catHeader.appendChild(catToggle);
    catSection.appendChild(catHeader);

    const catBody = document.createElement('div');
    catBody.className = 'layer-category-body';
    catBody.style.display = 'none'; // padr√£o: minimizado

    Object.keys(grouped[cat]).sort((a, b) => a.localeCompare(b, 'pt-BR')).forEach(sub => {
      const subSection = document.createElement('div');
      subSection.className = 'layer-subcategory';

      const subHeader = document.createElement('div');
      subHeader.className = 'layer-subcategory-header';

      const subTitle = document.createElement('span');
      subTitle.textContent = sub;

      const subToggle = document.createElement('div');
      subToggle.className = 'layer-subcategory-toggle';
      subToggle.textContent = '+'; // padr√£o: minimizado

      subHeader.appendChild(subTitle);
      subHeader.appendChild(subToggle);
      subSection.appendChild(subHeader);

      const subBody = document.createElement('div');
      subBody.className = 'layer-subcategory-body';

      grouped[cat][sub]
        .slice()
        .sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR'))
        .forEach(preset => {
          const row = createRow(preset);
          subBody.appendChild(row);
        });

      subSection.appendChild(subBody);
      catBody.appendChild(subSection);
    });

    // Toggle categoria (minimizar/maximizar)
    catHeader.addEventListener('click', () => {
      const isHidden = catBody.style.display === 'none';
      catBody.style.display = isHidden ? 'block' : 'none';
      catToggle.textContent = isHidden ? '‚àí' : '+';
    });

    // Toggle subcategoria (minimizar/maximizar)
    catBody.querySelectorAll('.layer-subcategory').forEach(subSection => {
      const header = subSection.querySelector('.layer-subcategory-header');
      const body = subSection.querySelector('.layer-subcategory-body');
      const toggle = subSection.querySelector('.layer-subcategory-toggle');

      header.addEventListener('click', (e) => {
        // evita que o clique na subcategoria afete a categoria
        e.stopPropagation();
        const isHidden = body.style.display === 'none';
        body.style.display = isHidden ? 'block' : 'none';
        toggle.textContent = isHidden ? '‚àí' : '+';
      });
    });

    catSection.appendChild(catBody);
    presetLayerList.appendChild(catSection);
  });
}

buildPresetList();
// LISTA DE CAMADAS PR√â-DEFINIDAS (WMS) - Fim



// >>>>>>>>>>>>>>>>>>>>>> fUN√á√ïES NA SIDEBAR - Inicio >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// Toggle "Camadas dispon√≠veis" (minimizado por padr√£o)
const availableLayersToggle = document.getElementById('availableLayersToggle');
const availableLayersChevron = document.getElementById('availableLayersChevron');
const availableLayersContent = document.getElementById('availableLayersContent');
availableLayersToggle.addEventListener('click', function(){
  const isHidden = availableLayersContent.style.display === 'none';
  availableLayersContent.style.display = isHidden ? 'flex' : 'none';
  availableLayersChevron.textContent = isHidden ? '‚ñæ' : '‚ñ∏';
});

// Busca de camadas (filtro por nome)
const layerSearchInput = document.getElementById('layerSearchInput');
layerSearchInput.addEventListener('input', function() {
  const q = layerSearchInput.value.trim().toLowerCase();

  // Filtra diretamente as linhas de camada
  const items = Array.from(presetLayerList.querySelectorAll('.layer-row'));
  items.forEach(item => {
    const name = (item.dataset.name || '').toLowerCase();
    item.style.display = name.indexOf(q) !== -1 ? '' : 'none';
  });

  // Mostra/oculta subcategorias conforme resultado
  const subSections = Array.from(presetLayerList.querySelectorAll('.layer-subcategory'));
  subSections.forEach(sub => {
    const rows = Array.from(sub.querySelectorAll('.layer-row'));
    const anyVisible = rows.some(r => r.style.display !== 'none');
    sub.style.display = anyVisible ? '' : 'none';
  });

  // Mostra/oculta categorias conforme resultado
  const catSections = Array.from(presetLayerList.querySelectorAll('.layer-category'));
  catSections.forEach(cat => {
    const visibleSub = Array.from(cat.querySelectorAll('.layer-subcategory')).some(s => s.style.display !== 'none');
    cat.style.display = visibleSub ? '' : 'none';
  });
});

// Toggle "Im√≥veis Urbanos" (minimizado por padr√£o)
const imoveisUrbanosToggle = document.getElementById('imoveisUrbanosToggle');
const imoveisUrbanosChevron = document.getElementById('imoveisUrbanosChevron');
const imoveisUrbanosPanel = document.getElementById('imoveisUrbanosPanel');
imoveisUrbanosToggle.addEventListener('click', function(){
  const isHidden = imoveisUrbanosPanel.style.display === 'none';
  imoveisUrbanosPanel.style.display = isHidden ? 'flex' : 'none';
  imoveisUrbanosChevron.textContent = isHidden ? '‚ñæ' : '‚ñ∏';
});

// Fun√ß√£o de pesquisa de im√≥vel urbano
document.getElementById('searchImovelBtn').addEventListener('click', function() {
  const inscricao = document.getElementById('searchInscricaoImovel').value.trim();
  const distrito = document.getElementById('searchDistritoImovel').value.trim();
  const setor = document.getElementById('searchSetorImovel').value.trim();
  const quadra = document.getElementById('searchQuadraImovel').value.trim();
  const lote = document.getElementById('searchLoteImovel').value.trim();

  if (!lotesLayer) {
    alert("Camada de lotes n√£o carregada!");
    return;
  }

  let found = false;

  lotesLayer.eachLayer(layer => {
    const props = layer.feature.properties;

    // Verifica se todos os campos preenchidos correspondem
    const match = 
      (!inscricao || (props.n_inscricao && props.n_inscricao.includes(inscricao))) &&
      (!distrito || (props.cd_distrito && props.cd_distrito.includes(distrito))) &&
      (!setor || (props.cd_setor_fiscal && props.cd_setor_fiscal.includes(setor))) &&
      (!quadra || (props.cd_quadra && props.cd_quadra.includes(quadra))) &&
      (!lote || (props.cd_lote && props.cd_lote.includes(lote)));

    if (match) {
      // Centraliza e abre popup do lote encontrado
      map.fitBounds(layer.getBounds());
      layer.openPopup();
      found = true;
    }
  });

  if (!found) {
    alert("Nenhum im√≥vel encontrado com os crit√©rios informados.");
  }
});

//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> FUN√á√ÉO MEDIR- Inicio >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
var medLineBtn = document.getElementById('medLineBtn');
var measuring = false;
var points = [];
var tempLine = null;
var tempMarkers = [];
var distanceLabel = null;

// Ativar/desativar medi√ß√£o
medLineBtn.addEventListener('click', function() {
    measuring = !measuring;
   
    limparMedicao(); // sempre limpa antes de come√ßar ou sair

    // Limpa medi√ß√£o anterior
    //points = [];
   // tempMarkers.forEach(m => map.removeLayer(m));
   // tempMarkers = [];
   // if(tempLine) map.removeLayer(tempLine);
   // tempLine = null;
   // if(distanceLabel) map.removeLayer(distanceLabel);
   // distanceLabel = null;

    if(measuring){
        medLineBtn.style.background = 'var(--terciariacont)'; // muda cor para indicar ativo
        medLineBtn.style.color = "#063940";      // √≠cone e texto nessa cor
        map.getContainer().style.cursor = 'crosshair';
    } else {
        medLineBtn.style.background = 'var(primariocont)'; // cor normal
        map.getContainer().style.cursor = '';
    }
});


// Clique no mapa para adicionar pontos
map.on('click', function(e) {
    if(!measuring) return;

    points.push([e.latlng.lat, e.latlng.lng]);

    // Adiciona marcador
    var marker = L.circleMarker([e.latlng.lat, e.latlng.lng], {
       radius: 2,
      color: '#ece1c3',
      fillColor: '#8ebdb6',
      fillOpacity: 10
    }).addTo(map);
    tempMarkers.push(marker);

    // Atualiza linha
    if(points.length > 1){
        if(tempLine) map.removeLayer(tempLine);
        tempLine = L.polyline(points, {color: '#ece1c3', weight: 1}).addTo(map);

        // Calcula dist√¢ncia total
        var distance = 0;
        for(var i=1; i<points.length; i++){
            distance += map.distance(points[i-1], points[i]);
        }

        // Exibe dist√¢ncia sobre o √∫ltimo segmento da linha
if(points.length > 1){
    // Remove label anterior
    if(distanceLabel) map.removeLayer(distanceLabel);

    // Calcula ponto m√©dio do √∫ltimo segmento
    var lat1 = points[points.length-2][0];
    var lng1 = points[points.length-2][1];
    var lat2 = points[points.length-1][0];
    var lng2 = points[points.length-1][1];
    var midLat = (lat1 + lat2) / 2;
    var midLng = (lng1 + lng2) / 2;

    // Cria label sobre a linha
    distanceLabel = L.marker([midLat, midLng], {
    icon: L.divIcon({
        className: 'distance-label',
        html: `<div style="
                display:flex;
                align-items:center;
                justify-content:center;
                white-space: nowrap;   /* evita quebra de linha */
                /*background: #0a2156;*/
                color: #43474e;
                font-weight:bold;
                font-size:12px;
                padding:2px 4pcalx;
                border-radius:1px;
                text-shadow:
                     -2px 0 #ffffff,
                      2px 0 #ffffff,
                      0 -2px #ffffff,
                     0  2px #ffffff,
                      -2px -2px #ffffff,
                      2px -2px #ffffff,
                      -2px  2px #ffffff,
                      2px  2px #ffffff;;
              ">
                ${distance.toFixed(2)} m
               </div>`,
        iconAnchor: [0, 6]
    })
}).addTo(map);
}
    }
});

// FUN√á√ÉO MEDIR- Fim

// >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>          FUN√á√ÉO MEDIR √ÅREA- In√≠cio       >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
const medAreaBtn = document.getElementById('medAreaBtn'); /// Bot√£o de medir √°rea
let medindoArea = false;
let areaPoints = [];
let areaPolygon = null;
let areaLine = null;
let areaMarkers = [];
let areaLabel = null;


// Fun√ß√£o para formatar n√∫mero no padr√£o brasileiro
function formatNumberBR(value) {
    return value.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}


// Fun√ß√£o para calcular √°rea (fallback se GeometryUtil n√£o estiver dispon√≠vel)
function calcularArea(points) {
    if (window.L && L.GeometryUtil && L.GeometryUtil.geodesicArea) {
        return L.GeometryUtil.geodesicArea(points);
    } else {
        let area = 0;
        for (let i = 0; i < points.length; i++) {
            const j = (i + 1) % points.length;
            area += points[i].lng * points[j].lat - points[j].lng * points[i].lat;
        }
        return Math.abs(area / 2 * 111319.9 * 111319.9);
    }
}


// Fun√ß√£o para limpar todos os elementos de medi√ß√£o
function limparMedicao() {
    if (areaPolygon) map.removeLayer(areaPolygon);
    if (areaLine) map.removeLayer(areaLine);
    if (areaLabel) map.removeLayer(areaLabel);
    areaMarkers.forEach(m => map.removeLayer(m));
    areaMarkers = [];
    areaPoints = [];
    areaPolygon = null;
    areaLine = null;
    areaLabel = null;
}


// Remover √∫ltimo v√©rtice com Delete (pol√≠gono)
document.addEventListener('keydown', function(e) {
    if (!medindoArea) return;   // s√≥ funciona se estiver medindo √°rea
    if (e.key === "Delete") {
        if (areaPoints.length > 0) {
            // Remove √∫ltimo marcador
            const lastMarker = areaMarkers.pop();
            map.removeLayer(lastMarker);
            
            // Remove √∫ltimo ponto
            areaPoints.pop();

            // Remove pol√≠gono e linha existentes
            if(areaLine) map.removeLayer(areaLine);
            if(areaPolygon) map.removeLayer(areaPolygon);
            if(areaLabel) map.removeLayer(areaLabel);

            // Redesenha linha tracejada
            if (areaPoints.length > 1) {
                areaLine = L.polyline(areaPoints, {
                    color: '#43474e',
                    weight: 1.5,
                    dashArray: '5,5'
                }).addTo(map);
            }

            // Redesenha pol√≠gono e r√≥tulo de √°rea se houver 3 ou mais pontos
            if (areaPoints.length >= 3) {
                areaPolygon = L.polygon(areaPoints, {
                    color: '#43474e',
                    weight: 1.5,
                    fillColor: '#afc5ff',
                    fillOpacity: 0.4,
                    dashArray: '5,5'
                }).addTo(map);

                const area = calcularArea(areaPoints);
                const areaFormatted = `${formatNumberBR(area)} m¬≤`;

                const center = areaPolygon.getBounds().getCenter();
                areaLabel = L.marker(center, {
                    icon: L.divIcon({
                        className: 'area-label',
                        html: `<div style="
                            display:flex;
                            align-items:center;
                            justify-content:center;
                            white-space: nowrap;
                            color: #43474e;
                            font-weight:bold;
                            font-size:12px;
                            padding:2px 4px;
                            border-radius:1px;
                            text-shadow:
                                 -2px 0 #ffffff,
                                  2px 0 #ffffff,
                                  0 -2px #ffffff,
                                  0  2px #ffffff,
                                  -2px -2px #ffffff,
                                  2px -2px #ffffff,
                                  -2px  2px #ffffff,
                                  2px  2px #ffffff;
                        ">${areaFormatted}</div>`
                    })
                }).addTo(map);
            }
        }
    }
});

// Ativar/desativar medi√ß√£o de √°rea
medAreaBtn.addEventListener('click', function () {
    medindoArea = !medindoArea;


    limparMedicao(); // sempre limpa antes de come√ßar ou sair


    if (medindoArea) {
        medAreaBtn.style.background = "#ece1c3"; // indica ativo
        map.getContainer().style.cursor = 'crosshair';
    } else {
        medAreaBtn.style.background = ""; // volta ao normal
        map.getContainer().style.cursor = '';
    }
});


// Clique no mapa para desenhar √°rea
map.on('click', function (e) {
    if (!medindoArea) return;


    const latlng = e.latlng;
    areaPoints.push(latlng);


    // Adiciona marcador no ponto
    const marker = L.circleMarker(latlng, {
        radius: 2,
        color: '#43474e',
        fillColor: '#43474e',
        fillOpacity: 1
    }).addTo(map);
    areaMarkers.push(marker);

// Atualiza linha tracejada
if (areaPoints.length > 1) {
        if (areaLine) map.removeLayer(areaLine);
        areaLine = L.polyline(areaPoints, {
            color: '#43474e',
            weight: 1.5,
            dashArray: '5,5'
        }).addTo(map);
    }


    // Atualiza pol√≠gono e r√≥tulo de √°rea
    if (areaPoints.length >= 3) {
        if (areaPolygon) map.removeLayer(areaPolygon);
        if (areaLabel) map.removeLayer(areaLabel);


        areaPolygon = L.polygon(areaPoints, {
            color: '#43474e',
            weight: 1.5,
            fillColor: '#afc5ff',
            fillOpacity: 0.4,
            dashArray: '5,5'
        }).addTo(map);


        const area = calcularArea(areaPoints);
        const areaFormatted = `${formatNumberBR(area)} m¬≤`;

        // Centraliza o texto dentro do pol√≠gono
const center = areaPolygon.getBounds().getCenter();
areaLabel = L.marker(center, {
    icon: L.divIcon({
        className: 'area-label',
        html: `<div style="
            display:flex;
            align-items:center;
            justify-content:center;
            white-space: nowrap;   /* evita quebra de linha */
            color: #43474e;
            font-weight:bold;
            font-size:12px;
            padding:2px 4px;
            border-radius:1px;
            text-shadow:
                 -2px 0 #ffffff,
                  2px 0 #ffffff,
                  0 -2px #ffffff,
                  0  2px #ffffff,
                  -2px -2px #ffffff,
                  2px -2px #ffffff,
                  -2px  2px #ffffff,
                  2px  2px #ffffff;
        ">${areaFormatted}</div>`
    })
}).addTo(map);
    }
});


// Finaliza medi√ß√£o com duplo clique
map.on('dblclick', function () {
    if (!medindoArea) return;
    medindoArea = false;
    medAreaBtn.style.background = "";
    map.getContainer().style.cursor = '';
});

// FUN√á√ÉO MEDIR √ÅREA- Fim

  </script>

  <!-- FOOTER COM COORDENADAS -->
  <div class="footer">
    <!-- <div id="coords">Coordenadas: -3.608388, -38.966187</div>
    <div>EPSG: 4674</div>
  </div>
-->
  <!-- LOGO SEFIN CENTRALIZADA SOBRE O MAPA -->
  <div class="sefin-logo">
    <img src="https://sefin.pmsga.ce.gov.br/wp-content/uploads/2025/03/FINANCAS@2x.png" alt="Logo SEFIN" title="Secretaria de Finan√ßas - S√£o Gon√ßalo do Amarante">
  </div>
</body>
</html>
